<!doctype html>
<html>

<head>

  <title>at-form-text tests</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/test-helpers.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="../at-core-propform.html">

</head>

<body>

  <test-fixture>
    <template>
      <at-core-propform></at-core-propform>
    </template>
  </test-fixture>

  <script>
    suite('tests for elementInstance and value where elementInstance and value are set as properties', function() {

      suite('tests for invalid values', function () {

        test('invalid elementInstance, invalid value both provided as arrays of invalid values', function() {
          var invalidElementInstances = [ undefined, null, "", "undefined", "null", true, false, "true", "false", [], function() { return undefined; }];
          var invalidValues = [ undefined, null, "", "undefined", "null", true, false, "true", "false", [], function() { return undefined; }];

          var propForm = document.createElement('at-core-propform');
          var coreForm = propForm.$.propForm;
          var insertPoint = coreForm.$.insertPoint;

          for (var i = 0; i < invalidElementInstances.length; i++) {
            var elementInstance = invalidElementInstances[i];
            for (var j = 0; j < invalidValues.length; j++) {
              var value = invalidValues[j];
              propForm.elementInstance = elementInstance;
              propForm.value = value;

              assert.isObject(coreForm._internalData, 'internal data is not set');
              assert.equal(Object.keys(coreForm._internalData).length, 0, 'internal data is not empty');
              assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
              assert.equal(coreForm._elementsToValidate.length, 0, 'elements to validate is not empty');
              assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point is not empty');
            }
          }
        });

        test('invalid elementInstance, valid value --- elementInstance is provided as array of invalid values, value is empty object', function() {
          var invalidElementInstances = [ undefined, null, "", "undefined", "null", true, false, "true", "false", [], function() { return undefined; }];
          var value = {};

          var propForm = document.createElement('at-core-propform');
          var coreForm = propForm.$.propForm;
          var insertPoint = coreForm.$.insertPoint;

          for (var i = 0; i < invalidElementInstances.length; i++) {
            var elementInstance = invalidElementInstances[i];
            propForm.elementInstance = elementInstance;
            propForm.value = value;

            assert.isObject(coreForm._internalData, 'internal data is not set');
            assert.equal(Object.keys(coreForm._internalData).length, 0, 'internal data is not empty');
            assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
            assert.equal(coreForm._elementsToValidate.length, 0, 'elements to validate is not empty');
            assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point is not empty');
          }
        });

        test('elementInstance is valid, value is invalid - element instance is at-form-text, value is array of invalid values', function() {
          var elementInstance = document.createElement('at-form-text');
          var invalidValues = [ undefined, null, "", "undefined", "null", true, false, "true", "false", [], function() { return undefined; }];

          var propForm = document.createElement('at-core-propform');
          var coreForm = propForm.$.propForm;
          var insertPoint = coreForm.$.insertPoint;

          for (var j = 0; j < invalidValues.length; j++) {
            var value = invalidValues[j];
            coreForm.elementInstance = elementInstance;
            coreForm.value = value;

            assert.isObject(coreForm._internalData, 'internal data is not set');
            assert.equal(Object.keys(coreForm._internalData).length, 0, 'internal data is not empty');
            assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
            assert.equal(coreForm._elementsToValidate.length, 0, 'elements to validate is not empty');
            assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point is not empty');
          }
        });

      });

      /********************************************************************************/
      /* utility functions for working with element.properties and element.behaviors
      /********************************************************************************/

      function getPropertyCount(elementInstance) {
        var elementInstanceProperties = elementInstance.properties;
        var propertyCount = Object.keys(elementInstanceProperties).length;

        if (!schemaHelpers.isArray(elementInstance.behaviors)) {
          return propertyCount;
        }

        for (var i = 0; i < elementInstance.behaviors.length; i++) {
          var behavior = elementInstance.behaviors[i];
          if (!schemaHelpers.isObject(behavior.properties)) {
            continue;
          }
          var behaviorPropertyNames = Object.keys(behavior.properties);
          behaviorPropertyNames.forEach(function (behaviorPropertyName, index) {
            var behaviorPropertyDefinition = behavior.properties[behaviorPropertyName];
            if (behaviorPropertyDefinition.readOnly === undefined || behaviorPropertyDefinition.readOnly === false) {
                propertyCount += 1;
            }
          });
        }

        return propertyCount;
      }

      function getPropertyNames(elementInstance) {
        var elementInstanceProperties = elementInstance.properties;
        var propertyNames = Object.keys(elementInstanceProperties);

        if (!schemaHelpers.isArray(elementInstance.behaviors)) {
          return propertyNames;
        }

        for (var i = 0; i < elementInstance.behaviors.length; i++) {
          var behavior = elementInstance.behaviors[i];
          if (!schemaHelpers.isObject(behavior.properties)) {
            continue;
          }
          var behaviorPropertyNames = Object.keys(behavior.properties);
          behaviorPropertyNames.forEach(function (behaviorPropertyName, index) {
            var behaviorPropertyDefinition = behavior.properties[behaviorPropertyName];
            if (behaviorPropertyDefinition.readOnly === undefined || behaviorPropertyDefinition.readOnly === false) {
                propertyNames.push(behaviorPropertyName);
            }
          });
        }

        return propertyNames;
      }

      function getPropertyDefinition(propertyName, elementInstance) {
        if (elementInstance.properties.hasOwnProperty(propertyName)){
          return elementInstance.properties[propertyName];
        }

        if (!schemaHelpers.isArray(elementInstance.behaviors)) {
          return { };
        }

        for (var i = 0; i < elementInstance.behaviors.length; i++) {
          var behavior = elementInstance.behaviors[i];
          if (!schemaHelpers.isObject(behavior.properties)) {
            continue;
          }

          if (behavior.properties.hasOwnProperty(propertyName)) {
            return behavior.properties[propertyName];
          }
        }

        return { };
      }

      suite('elementInstance is valid, value is valid -- elementInstance set first, value next', function() {

        function getElementInstace() {
          return document.createElement('at-form-text');
        }

        function getData() {
          return {
            value: "lorem ipsum",
            hideLabel: "true",
            disabled: true,
            label: "lorem ipsum",
            maxChars: 5
          };
        }

        var stringData = JSON.stringify(getData());

        test('elementInstance is at-form-text, data is string', function(done) {
          var propForm = document.createElement('at-core-propform');
          var elementInstance = getElementInstace();
          propForm.elementInstance = elementInstance;

          var propertyCount = getPropertyCount(elementInstance);
          var propertyNames = getPropertyNames(elementInstance);
          var coreForm = propForm.$.propForm;

          // _internalData and data must have entries for each element
          assert.equal(propertyCount, propertyNames.length, 'property names length doesn\'t match property count');
          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          var testData = getData();

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var initialPropertyValue = getPropertyDefinition(propertyName, elementInstance).value;

            assert.equal(coreForm._internalData[propertyName], initialPropertyValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], initialPropertyValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual( propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1+propertyCount, 'insert point doesn\'t contain corrent number of elements');

          var eventCount = 0;
          coreForm.addEventListener('data-changed', function(event) {
            eventCount += 1;
          });

          coreForm.data = stringData;

          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var expectedValue = getPropertyDefinition(propertyName, elementInstance).value;

            var testData = getData();
            if (testData.hasOwnProperty(propertyName)) {
              expectedValue = testData[propertyName];
            }

            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual( propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1 + propertyCount, 'insert point doesn\'t contain corrent number of elements');

          flush(function() {
            assert.equal(eventCount, 1, 'at-core-propform didn\'t fire corrent number of events');
            done();
          });
        });

        test('elementInstance is at-form-text, data is object', function(done) {
          var propForm = document.createElement('at-core-propform');
          var elementInstance = getElementInstace();
          propForm.elementInstance = elementInstance;

          var propertyCount = getPropertyCount(elementInstance);
          var propertyNames = getPropertyNames(elementInstance);
          var coreForm = propForm.$.propForm;

          // _internalData and data must have entries for each element
          assert.equal(propertyCount, propertyNames.length, 'property names length doesn\'t match property count');
          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          var testData = getData();

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var initialPropertyValue = getPropertyDefinition(propertyName, elementInstance).value;

            assert.equal(coreForm._internalData[propertyName], initialPropertyValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], initialPropertyValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual( propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1+propertyCount, 'insert point doesn\'t contain corrent number of elements');

          var eventCount = 0;
          coreForm.addEventListener('data-changed', function(event) {
            eventCount += 1;
          });

          coreForm.data = getData();

          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var expectedValue = getPropertyDefinition(propertyName, elementInstance).value;

            var testData = getData();
            if (testData.hasOwnProperty(propertyName)) {
              expectedValue = testData[propertyName];
            }

            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual( propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1 + propertyCount, 'insert point doesn\'t contain corrent number of elements');

          flush(function() {
            assert.equal(eventCount, 1, 'at-core-propform didn\'t fire corrent number of events');
            done();
          });
        });
      });

      suite('elementInstance is valid, data is valid, value is set first, elementInstance next', function() {

        function getElementInstace() {
          return document.createElement('at-form-text');
        }

        function getData() {
          return {
            value: "lorem ipsum",
            hideLabel: "true",
            disabled: true,
            label: "lorem ipsum",
            maxChars: 5
          };
        }

        var stringData = JSON.stringify(getData());

        test('elementInstance is at-form-text, value is string', function(done) {
          var propForm = document.createElement('at-core-propform');
          var coreForm = propForm.$.propForm;
          var elementInstance = document.createElement('at-form-text');

          var eventCount = 0;
          coreForm.addEventListener('data-changed', function(event) {
            eventCount += 1;
          });

          propForm.value = stringData;

          // internalData must have entries for each element
          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, 5, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, 5, 'data doesn\'t contain correct number of properties');

          var testData = getData();
          var testDataPropertyNames = Object.keys(testData);
          testDataPropertyNames.forEach(function (propertyName, index) {
            var expectedValue = testData[propertyName];
            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          });

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, 0, 'elements to validate doesn\'t contain corrent number of elements');

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point doesn\'t contain corrent number of elements');

          propForm.elementInstance = elementInstance;
          var propertyCount = getPropertyCount(elementInstance);
          var propertyNames = getPropertyNames(elementInstance);

          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, '_internalData doesn\'t contain correct number of properties');

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var expectedValue = getPropertyDefinition(propertyName, elementInstance).value;

            var testData = getData();
            if (testData.hasOwnProperty(propertyName)) {
              expectedValue = testData[propertyName];
            }

            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual(propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1 + propertyCount, 'insert point doesn\'t contain corrent number of elements');

          flush(function() {
            assert.equal(eventCount, 2, 'at-core-propform didn\'t fire corrent number of events');
            done();
          });
        });

        test('elementInstance is at-form-text, value is object', function(done) {
          var propForm = document.createElement('at-core-propform');
          var coreForm = propForm.$.propForm;
          var elementInstance = document.createElement('at-form-text');

          var eventCount = 0;
          coreForm.addEventListener('data-changed', function(event) {
            eventCount += 1;
          });

          propForm.value = getData();

          // internalData must have entries for each element
          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, 5, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, 5, 'data doesn\'t contain correct number of properties');

          var testData = getData();
          var testDataPropertyNames = Object.keys(testData);
          testDataPropertyNames.forEach(function (propertyName, index) {
            var expectedValue = testData[propertyName];
            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          });

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, 0, 'elements to validate doesn\'t contain corrent number of elements');

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point doesn\'t contain corrent number of elements');

          propForm.elementInstance = elementInstance;
          var propertyCount = getPropertyCount(elementInstance);
          var propertyNames = getPropertyNames(elementInstance);

          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, '_internalData doesn\'t contain correct number of properties');

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var expectedValue = getPropertyDefinition(propertyName, elementInstance).value;

            var testData = getData();
            if (testData.hasOwnProperty(propertyName)) {
              expectedValue = testData[propertyName];
            }

            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual(propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1 + propertyCount, 'insert point doesn\'t contain corrent number of elements');

          flush(function() {
            assert.equal(eventCount, 2, 'at-core-propform didn\'t fire corrent number of events');
            done();
          });
        });

        test('elementInstance is at-form-text, value is object, data is set first, elementInstance next, set value for individual elements after', function(done) {
          var propForm = document.createElement('at-core-propform');
          var coreForm = propForm.$.propForm;
          var elementInstance = document.createElement('at-form-text');

          var eventCount = 0;
          coreForm.addEventListener('data-changed', function(event) {
            eventCount += 1;
          });

          propForm.value = getData();

          // internalData must have entries for each element
          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, 5, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, 5, 'data doesn\'t contain correct number of properties');

          var testData = getData();
          var testDataPropertyNames = Object.keys(testData);
          testDataPropertyNames.forEach(function (propertyName, index) {
            var expectedValue = testData[propertyName];
            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          });

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, 0, 'elements to validate doesn\'t contain corrent number of elements');

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point doesn\'t contain corrent number of elements');

          propForm.elementInstance = elementInstance;
          var propertyCount = getPropertyCount(elementInstance);
          var propertyNames = getPropertyNames(elementInstance);

          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, '_internalData doesn\'t contain correct number of properties');

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var expectedValue = getPropertyDefinition(propertyName, elementInstance).value;

            var testData = getData();
            if (testData.hasOwnProperty(propertyName)) {
              expectedValue = testData[propertyName];
            }

            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual(propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1 + propertyCount, 'insert point doesn\'t contain corrent number of elements');


          var testData1 = {
            value: 'value lorem ipsum',
            hideLabel: 'false',
            disabled: false,
            label: 'label lorem ipsum',
            maxChars: 10
          };
          var testData1PropertyNames = Object.keys(testData1);

          /* these should trigger 5 data data-changed events */
          coreForm.updateFormElementData('value', 'value lorem ipsum');
          coreForm.updateFormElementData('hideLabel', 'false');
          coreForm.updateFormElementData('disabled', false);
          coreForm.updateFormElementData('label', 'label lorem ipsum');
          coreForm.updateFormElementData('maxChars', 10);

          assert.isObject(coreForm._internalData, '_internalData is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.isObject(coreForm.data, 'data is not set');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          for (var i = 0; i < testData1PropertyNames.length; i++) {
            var propertyName = testData1PropertyNames[i];
            assert.equal(coreForm._internalData[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in data', propertyName));
          }
          /* these should not trigger any events */
          coreForm.updateFormElementData('value', 'value lorem ipsum');
          coreForm.updateFormElementData('hideLabel', 'false');
          coreForm.updateFormElementData('disabled', false);
          coreForm.updateFormElementData('label', 'label lorem ipsum');
          coreForm.updateFormElementData('maxChars', 10);

          assert.isObject(coreForm._internalData, '_internalData is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.isObject(coreForm.data, 'data is not set');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          for (var i = 0; i < testData1PropertyNames.length; i++) {
            var propertyName = testData1PropertyNames[i];
            assert.equal(coreForm._internalData[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in data', propertyName));
          }

          flush(function() {
            assert.equal(eventCount, 7, 'at-core-propform didn\'t fire corrent number of events');
            done();
          });
        });

      });

      suite('elementInstance is valid, value is valid, set values on individual properties', function() {

        function getElementInstace() {
          return document.createElement('at-form-text');
        }

        function getData() {
          return {
            value: "lorem ipsum",
            hideLabel: "true",
            disabled: true,
            label: "lorem ipsum",
            maxChars: 5
          };
        }

        test('elementInstance is at-form-text, value is object,  elementInstance is set first, value next, set value for individual properties', function(done) {
          var propForm = document.createElement('at-core-propform');
          var coreForm = propForm.$.propForm;
          var elementInstance = document.createElement('at-form-text');

          var eventCount = 0;
          coreForm.addEventListener('data-changed', function(event) {
            eventCount += 1;
          });

          propForm.elementInstance = elementInstance;
          var propertyCount = getPropertyCount(elementInstance);
          var propertyNames = getPropertyNames(elementInstance);

          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, '_internalData doesn\'t contain correct number of properties');

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var expectedValue = getPropertyDefinition(propertyName, elementInstance).value;

            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual(propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1 + propertyCount, 'insert point doesn\'t contain corrent number of elements');

          propForm.value = getData();

          // internalData must have entries for each element
          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          var testData = getData();
          var testDataPropertyNames = Object.keys(testData);
          testDataPropertyNames.forEach(function (propertyName, index) {
            var expectedValue = testData[propertyName];

            if (testData.hasOwnProperty(propertyName)) {
              expectedValue = testData[propertyName];
            }

            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          });

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1 + propertyCount, 'insert point doesn\'t contain corrent number of elements');

          var testData1 = {
            value: 'value lorem ipsum',
            hideLabel: 'false',
            disabled: false,
            label: 'label lorem ipsum',
            maxChars: 10
          };
          var testData1PropertyNames = Object.keys(testData1);

          /* these should trigger 5 data data-changed events */
          coreForm.updateFormElementData('value', 'value lorem ipsum');
          coreForm.updateFormElementData('hideLabel', 'false');
          coreForm.updateFormElementData('disabled', false);
          coreForm.updateFormElementData('label', 'label lorem ipsum');
          coreForm.updateFormElementData('maxChars', 10);

          assert.isObject(coreForm._internalData, '_internalData is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.isObject(coreForm.data, 'data is not set');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          for (var i = 0; i < testData1PropertyNames.length; i++) {
            var propertyName = testData1PropertyNames[i];
            assert.equal(coreForm._internalData[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in data', propertyName));
          }
          /* these should not trigger any events */
          coreForm.updateFormElementData('value', 'value lorem ipsum');
          coreForm.updateFormElementData('hideLabel', 'false');
          coreForm.updateFormElementData('disabled', false);
          coreForm.updateFormElementData('label', 'label lorem ipsum');
          coreForm.updateFormElementData('maxChars', 10);

          assert.isObject(coreForm._internalData, '_internalData is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.isObject(coreForm.data, 'data is not set');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          for (var i = 0; i < testData1PropertyNames.length; i++) {
            var propertyName = testData1PropertyNames[i];
            assert.equal(coreForm._internalData[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in data', propertyName));
          }

          flush(function() {
            assert.equal(eventCount, 7, 'at-core-propform didn\'t fire corrent number of events');
            done();
          });
        });

        test('elementInstance is at-form-text, value is object, value is set first, elementInstance next, set value for individual properties', function(done) {
          var propForm = document.createElement('at-core-propform');
          var coreForm = propForm.$.propForm;
          var elementInstance = document.createElement('at-form-text');

          var eventCount = 0;
          coreForm.addEventListener('data-changed', function(event) {
            eventCount += 1;
          });

          propForm.value = getData();

          // internalData must have entries for each element
          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, 5, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, 5, 'data doesn\'t contain correct number of properties');

          var testData = getData();
          var testDataPropertyNames = Object.keys(testData);
          testDataPropertyNames.forEach(function (propertyName, index) {
            var expectedValue = testData[propertyName];
            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          });

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, 0, 'elements to validate doesn\'t contain corrent number of elements');

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1, 'insert point doesn\'t contain corrent number of elements');

          propForm.elementInstance = elementInstance;
          var propertyCount = getPropertyCount(elementInstance);
          var propertyNames = getPropertyNames(elementInstance);

          assert.isObject(coreForm._internalData, 'internal data is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, '_internalData doesn\'t contain correct number of properties');

          for (var i = 0; i < propertyNames.length; i++) {
            var propertyName = propertyNames[i];
            var expectedValue = getPropertyDefinition(propertyName, elementInstance).value;

            var testData = getData();
            if (testData.hasOwnProperty(propertyName)) {
              expectedValue = testData[propertyName];
            }

            assert.equal(coreForm._internalData[propertyName], expectedValue, elementInstance.T('{0} value not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], expectedValue, elementInstance.T('{0} value not correct in data', propertyName));
          }

          assert.isArray(coreForm._elementsToValidate, 'elements to validate is not set');
          assert.equal(coreForm._elementsToValidate.length, propertyCount, 'elements to validate doesn\'t contain corrent number of elements');
          // _elementsToValidate must have entries for each element
          for (var i = 0; i < coreForm._elementsToValidate.length; i++) {
            var elementToValidate = coreForm._elementsToValidate[i];
            assert.notEqual(propertyNames.indexOf(elementToValidate.id), -1, elementInstance.T('{0} is missing from _elementsToValidate', elementToValidate.id));
          }

          var insertPoint = coreForm.$.insertPoint;
          assert.equal(Polymer.dom(insertPoint).children.length, 1 + propertyCount, 'insert point doesn\'t contain corrent number of elements');


          var testData1 = {
            value: 'value lorem ipsum',
            hideLabel: 'false',
            disabled: false,
            label: 'label lorem ipsum',
            maxChars: 10
          };
          var testData1PropertyNames = Object.keys(testData1);

          /* these should trigger 5 data data-changed events */
          coreForm.updateFormElementData('value', 'value lorem ipsum');
          coreForm.updateFormElementData('hideLabel', 'false');
          coreForm.updateFormElementData('disabled', false);
          coreForm.updateFormElementData('label', 'label lorem ipsum');
          coreForm.updateFormElementData('maxChars', 10);

          assert.isObject(coreForm._internalData, '_internalData is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.isObject(coreForm.data, 'data is not set');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          for (var i = 0; i < testData1PropertyNames.length; i++) {
            var propertyName = testData1PropertyNames[i];
            assert.equal(coreForm._internalData[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in data', propertyName));
          }
          /* these should not trigger any events */
          coreForm.updateFormElementData('value', 'value lorem ipsum');
          coreForm.updateFormElementData('hideLabel', 'false');
          coreForm.updateFormElementData('disabled', false);
          coreForm.updateFormElementData('label', 'label lorem ipsum');
          coreForm.updateFormElementData('maxChars', 10);

          assert.isObject(coreForm._internalData, '_internalData is not set');
          assert.equal(Object.keys(coreForm._internalData).length, propertyCount, '_internalData doesn\'t contain correct number of properties');
          assert.isObject(coreForm.data, 'data is not set');
          assert.equal(Object.keys(coreForm.data).length, propertyCount, 'data doesn\'t contain correct number of properties');

          for (var i = 0; i < testData1PropertyNames.length; i++) {
            var propertyName = testData1PropertyNames[i];
            assert.equal(coreForm._internalData[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in _internalData', propertyName));
            assert.equal(coreForm.data[propertyName], testData1[propertyName], elementInstance.T('{0} value is not correct in data', propertyName));
          }

          flush(function() {
            assert.equal(eventCount, 7, 'at-core-propform didn\'t fire corrent number of events');
            done();
          });
        });

      });



    });
  </script>
</body>

</html>
